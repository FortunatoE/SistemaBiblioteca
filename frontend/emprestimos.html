<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìñ Empr√©stimos - Biblioteca</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .emprestimo-card { transition: transform 0.2s; }
        .emprestimo-card:hover { transform: translateY(-2px); }
        .badge-ativo { background-color: #28a745; }
        .badge-devolvido { background-color: #6c757d; }
        .badge-atrasado { background-color: #dc3545; }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .multa-alerta {
            border-left: 4px solid #dc3545;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>
                Biblioteca Uniasselvi
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gestao-acervo.html">
                            <i class="fas fa-book me-1"></i>Acervo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="emprestimos.html">
                            <i class="fas fa-exchange-alt me-1"></i>Empr√©stimos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reserva.html">
                            <i class="fas fa-calendar-check me-1"></i>Reservas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html">
                            <i class="fas fa-users me-1"></i>Usu√°rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="estatisticas.html">
                            <i class="fas fa-chart-bar me-1"></i>Estat√≠sticas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="multas.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Multas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1><i class="fas fa-hand-holding me-2"></i>Gest√£o de Empr√©stimos</h1>
                <p class="lead">Controle de empr√©stimos, devolu√ß√µes e multas</p>
            </div>
        </div>

        <!-- Controles -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="buscaInput" class="form-control" placeholder="Buscar por usu√°rio ou livro...">
                    <button class="btn btn-outline-secondary" type="button" onclick="filtrarEmprestimos()">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success" onclick="abrirModalNovoEmprestimo()">
                    <i class="fas fa-plus me-2"></i>Novo Empr√©stimo
                </button>
            </div>
        </div>

        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="btn-group">
                    <button class="btn btn-outline-primary active" onclick="filtrarPorStatus('todos')">
                        Todos
                    </button>
                    <button class="btn btn-outline-primary" onclick="filtrarPorStatus('ativo')">
                        Ativos
                    </button>
                    <button class="btn btn-outline-primary" onclick="filtrarPorStatus('devolvido')">
                        Devolvidos
                    </button>
                    <button class="btn btn-outline-primary" onclick="filtrarPorStatus('atrasado')">
                        Em Atraso
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p>Carregando empr√©stimos...</p>
        </div>

        <!-- Mensagem de Erro -->
        <div id="error-message" class="alert alert-danger d-none" role="alert"></div>

        <!-- Estat√≠sticas -->
        <div id="estatisticas" class="row mb-4 d-none">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 id="total-emprestimos" class="text-primary">0</h3>
                        <p class="text-muted">Total</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 id="emprestimos-ativos" class="text-success">0</h3>
                        <p class="text-muted">Ativos</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 id="emprestimos-atraso" class="text-danger">0</h3>
                        <p class="text-muted">Em Atraso</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h3 id="total-multas" class="text-warning">R$ 0</h3>
                        <p class="text-muted">Multas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Empr√©stimos -->
        <div id="emprestimos-container" class="row"></div>
    </div>

    <!-- Modal Novo Empr√©stimo -->
    <div class="modal fade" id="modalEmprestimo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Novo Empr√©stimo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEmprestimo">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Usu√°rio *</label>
                                    <select class="form-select" id="usuario_id" required>
                                        <option value="">Selecione um usu√°rio...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Livro *</label>
                                    <select class="form-select" id="livro_id" required>
                                        <option value="">Selecione um livro...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Data de Devolu√ß√£o Prevista</label>
                            <input type="date" class="form-control" id="data_devolucao_prevista">
                            <div class="form-text">Deixe em branco para 15 dias a partir de hoje</div>
                        </div>
                        <div id="info-usuario" class="alert alert-info d-none"></div>
                        <div id="info-livro" class="alert alert-info d-none"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="realizarEmprestimo()">
                        <span id="btnEmprestimoText">Realizar Empr√©stimo</span>
                        <span id="btnEmprestimoLoading" class="d-none">
                            <span class="loading-spinner"></span> Processando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class GestaoEmprestimos {
            constructor() {
                this.apiUrl = 'http://localhost:3000/api';
                this.emprestimos = [];
                this.usuarios = [];
                this.livros = [];
                this.filtroStatus = 'todos';
                this.emprestimosFiltrados = [];
                this.init();
            }

            async init() {
                await this.carregarUsuarios();
                await this.carregarLivros();
                await this.carregarEmprestimos();
            }

            async carregarEmprestimos() {
                try {
                    const response = await fetch(`${this.apiUrl}/emprestimos`);
                    
                    if (!response.ok) throw new Error('API n√£o respondeu');
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.emprestimos = data.data;
                        this.aplicarFiltroAtual();
                    } else {
                        this.exibirErro('Erro: ' + data.error);
                    }
                } catch (error) {
                    this.exibirErro('N√£o foi poss√≠vel conectar com o servidor.');
                }
            }

            async carregarUsuarios() {
                try {
                    const response = await fetch(`${this.apiUrl}/usuarios`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.usuarios = data.data;
                    }
                } catch (error) {
                    console.error('Erro ao carregar usu√°rios:', error);
                }
            }

            async carregarLivros() {
                try {
                    const response = await fetch(`${this.apiUrl}/livros`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.livros = data.data.filter(livro => livro.quantidade_disponivel > 0);
                    }
                } catch (error) {
                    console.error('Erro ao carregar livros:', error);
                }
            }

            // FUN√á√ÉO PARA CALCULAR MULTA PENDENTE
            calcularMultaPendente(emprestimo) {
                if (emprestimo.status === 'ativo') {
                    const hoje = new Date();
                    const dataPrevista = new Date(emprestimo.data_devolucao_prevista);
                    
                    if (hoje > dataPrevista) {
                        const diasAtraso = Math.ceil((hoje - dataPrevista) / (1000 * 60 * 60 * 24));
                        return diasAtraso * 2.0; // R$ 2,00 por dia
                    }
                }
                return parseFloat(emprestimo.multa) || 0;
            }

            aplicarFiltroAtual() {
                let emprestimosFiltrados = [...this.emprestimos];

                // Aplicar filtro de busca se houver termo
                const termo = document.getElementById('buscaInput').value.toLowerCase();
                if (termo) {
                    emprestimosFiltrados = emprestimosFiltrados.filter(emp =>
                        emp.usuario_nome.toLowerCase().includes(termo) ||
                        emp.livro_titulo.toLowerCase().includes(termo) ||
                        emp.usuario_matricula.toLowerCase().includes(termo)
                    );
                }

                // Aplicar filtro de status
                if (this.filtroStatus !== 'todos') {
                    if (this.filtroStatus === 'atrasado') {
                        const hoje = new Date();
                        emprestimosFiltrados = emprestimosFiltrados.filter(emp => {
                            const dataPrevista = new Date(emp.data_devolucao_prevista);
                            return emp.status === 'ativo' && hoje > dataPrevista;
                        });
                    } else {
                        emprestimosFiltrados = emprestimosFiltrados.filter(emp => emp.status === this.filtroStatus);
                    }
                }

                this.emprestimosFiltrados = emprestimosFiltrados;
                this.exibirEmprestimos();
                this.exibirEstatisticas();
            }

            exibirEmprestimos() {
                const container = document.getElementById('emprestimos-container');
                const loading = document.getElementById('loading');
                
                loading.classList.add('d-none');
                document.getElementById('estatisticas').classList.remove('d-none');

                if (this.emprestimosFiltrados.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info text-center">
                                <i class="fas fa-info-circle me-2"></i>
                                Nenhum empr√©stimo encontrado.
                            </div>
                        </div>
                    `;
                    return;
                }

                const html = this.emprestimosFiltrados.map(emp => {
                    const hoje = new Date();
                    const dataPrevista = new Date(emp.data_devolucao_prevista);
                    const estaAtrasado = emp.status === 'ativo' && hoje > dataPrevista;
                    const multaCalculada = this.calcularMultaPendente(emp);
                    const temMulta = multaCalculada > 0;

                    return `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card emprestimo-card h-100 ${temMulta ? 'multa-alerta' : ''}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title">${emp.livro_titulo}</h6>
                                        <span class="badge ${this.getBadgeClass(emp.status, estaAtrasado)}">
                                            ${this.getStatusLabel(emp.status, estaAtrasado)}
                                        </span>
                                    </div>
                                    <p class="card-text">
                                        <strong>üë§ Usu√°rio:</strong> ${emp.usuario_nome}<br>
                                        <strong>üìã Matr√≠cula:</strong> ${emp.usuario_matricula}<br>
                                        <strong>‚úçÔ∏è Autor:</strong> ${emp.livro_autor}<br>
                                        <strong>üìÖ Empr√©stimo:</strong> ${new Date(emp.data_emprestimo).toLocaleDateString('pt-BR')}<br>
                                        <strong>üìÜ Devolu√ß√£o:</strong> ${new Date(emp.data_devolucao_prevista).toLocaleDateString('pt-BR')}
                                        ${estaAtrasado ? '<span class="text-danger">‚ö†Ô∏è Atrasado</span>' : ''}
                                    </p>
                                    ${emp.data_devolucao_efetiva ? `
                                        <p><strong>‚úÖ Devolvido em:</strong> ${new Date(emp.data_devolucao_efetiva).toLocaleDateString('pt-BR')}</p>
                                    ` : ''}
                                    ${temMulta ? `
                                        <p class="text-danger"><strong>üíµ Multa:</strong> R$ ${multaCalculada.toFixed(2)}</p>
                                    ` : ''}
                                </div>
                                <div class="card-footer">
                                    <small class="text-muted">ID: ${emp.id}</small>
                                    ${emp.status === 'ativo' ? `
                                        <button class="btn btn-sm btn-success float-end" onclick="registrarDevolucao(${emp.id})">
                                            <i class="fas fa-check me-1"></i>Devolver
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML = html;
            }

            exibirEstatisticas() {
                // Usar apenas os empr√©stimos filtrados para as estat√≠sticas
                const emprestimosParaEstatisticas = this.emprestimosFiltrados;
                
                const total = emprestimosParaEstatisticas.length;
                const ativos = emprestimosParaEstatisticas.filter(emp => emp.status === 'ativo').length;
                const atrasados = emprestimosParaEstatisticas.filter(emp => {
                    const hoje = new Date();
                    const dataPrevista = new Date(emp.data_devolucao_prevista);
                    return emp.status === 'ativo' && hoje > dataPrevista;
                }).length;
                
                // CALCULAR TOTAL DE MULTAS APENAS DOS EMPR√âSTIMOS FILTRADOS
                const totalMultas = emprestimosParaEstatisticas.reduce((sum, emp) => {
                    const multa = this.calcularMultaPendente(emp);
                    return sum + multa;
                }, 0);

                document.getElementById('total-emprestimos').textContent = total;
                document.getElementById('emprestimos-ativos').textContent = ativos;
                document.getElementById('emprestimos-atraso').textContent = atrasados;
                document.getElementById('total-multas').textContent = `R$ ${totalMultas.toFixed(2)}`;
            }

            getBadgeClass(status, estaAtrasado) {
                if (estaAtrasado) return 'badge-atrasado';
                const classes = {
                    'ativo': 'badge-ativo',
                    'devolvido': 'badge-devolvido',
                    'atrasado': 'badge-atrasado'
                };
                return classes[status] || 'badge-secondary';
            }

            getStatusLabel(status, estaAtrasado) {
                if (estaAtrasado) return 'Em Atraso';
                const labels = {
                    'ativo': 'Ativo',
                    'devolvido': 'Devolvido',
                    'atrasado': 'Em Atraso'
                };
                return labels[status] || status;
            }

            exibirErro(mensagem) {
                document.getElementById('loading').classList.add('d-none');
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = mensagem;
                errorDiv.classList.remove('d-none');
            }
        }

        let gestaoEmprestimos;

        // Fun√ß√µes globais
        function filtrarEmprestimos() {
            gestaoEmprestimos.aplicarFiltroAtual();
        }

        function filtrarPorStatus(status) {
            gestaoEmprestimos.filtroStatus = status;
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            gestaoEmprestimos.aplicarFiltroAtual();
        }

        async function abrirModalNovoEmprestimo() {
            const modal = new bootstrap.Modal(document.getElementById('modalEmprestimo'));
            
            // Popular select de usu√°rios
            const selectUsuario = document.getElementById('usuario_id');
            selectUsuario.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            gestaoEmprestimos.usuarios.forEach(usuario => {
                selectUsuario.innerHTML += `<option value="${usuario.id}">${usuario.matricula} - ${usuario.nome}</option>`;
            });

            // Popular select de livros dispon√≠veis
            const selectLivro = document.getElementById('livro_id');
            selectLivro.innerHTML = '<option value="">Selecione um livro...</option>';
            gestaoEmprestimos.livros.forEach(livro => {
                selectLivro.innerHTML += `<option value="${livro.id}">${livro.titulo} (${livro.quantidade_disponivel} disp.)</option>`;
            });

            // Limpar formul√°rio
            document.getElementById('formEmprestimo').reset();
            document.getElementById('info-usuario').classList.add('d-none');
            document.getElementById('info-livro').classList.add('d-none');

            modal.show();
        }

        async function realizarEmprestimo() {
            const btn = document.querySelector('#modalEmprestimo .btn-primary');
            const btnText = document.getElementById('btnEmprestimoText');
            const btnLoading = document.getElementById('btnEmprestimoLoading');

            const emprestimo = {
                usuario_id: document.getElementById('usuario_id').value,
                livro_id: document.getElementById('livro_id').value,
                data_devolucao_prevista: document.getElementById('data_devolucao_prevista').value
            };

            if (!emprestimo.usuario_id || !emprestimo.livro_id) {
                alert('Por favor, selecione usu√°rio e livro.');
                return;
            }

            try {
                // Mostrar loading
                btnText.classList.add('d-none');
                btnLoading.classList.remove('d-none');
                btn.disabled = true;

                const response = await fetch(`${gestaoEmprestimos.apiUrl}/emprestimos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(emprestimo)
                });

                const data = await response.json();

                if (data.success) {
                    // Fechar modal e recarregar lista
                    bootstrap.Modal.getInstance(document.getElementById('modalEmprestimo')).hide();
                    await gestaoEmprestimos.carregarEmprestimos();
                    alert('‚úÖ Empr√©stimo realizado com sucesso!');
                } else {
                    alert('‚ùå Erro: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erro de conex√£o: ' + error.message);
            } finally {
                // Restaurar bot√£o
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                btn.disabled = false;
            }
        }

        async function registrarDevolucao(emprestimoId) {
            if (confirm('Confirmar devolu√ß√£o deste livro?')) {
                try {
                    const response = await fetch(`${gestaoEmprestimos.apiUrl}/emprestimos/${emprestimoId}/devolucao`, {
                        method: 'PUT'
                    });

                    const data = await response.json();

                    if (data.success) {
                        await gestaoEmprestimos.carregarEmprestimos();
                        alert(data.message);
                    } else {
                        alert('‚ùå Erro: ' + data.error);
                    }
                } catch (error) {
                    alert('‚ùå Erro de conex√£o: ' + error.message);
                }
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            gestaoEmprestimos = new GestaoEmprestimos();
        });
    </script>
</body>
</html>