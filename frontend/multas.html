<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Multas - Biblioteca Uniasselvi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .stats-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: none;
            overflow: hidden;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        
        .module-section {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .multa-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .multa-pendente {
            border-left-color: #e74c3c;
        }

        .multa-paga {
            border-left-color: #27ae60;
        }

        .multa-isenta {
            border-left-color: #3498db;
        }

        .badge-status {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .btn-action {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .filter-section {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Toast personalizado */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-book-open me-2"></i>
                Biblioteca Uniasselvi
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="gestao-acervo.html">
                            <i class="fas fa-book me-1"></i>Acervo
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="emprestimos.html">
                            <i class="fas fa-exchange-alt me-1"></i>Empr√©stimos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reserva.html">
                            <i class="fas fa-calendar-check me-1"></i>Reservas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="usuarios.html">
                            <i class="fas fa-users me-1"></i>Usu√°rios
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="estatisticas.html">
                            <i class="fas fa-chart-bar me-1"></i>Estat√≠sticas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="multas.html">
                            <i class="fas fa-money-bill-wave me-1"></i>Multas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong id="toastTitle" class="me-auto"></strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div id="toastMessage" class="toast-body"></div>
        </div>
    </div>

    <div class="container py-5">
        <!-- Header -->
        <div class="row mb-5">
            <div class="col-12 text-center text-white">
                <h1 class="display-4 mb-3">üí∞ Controle de Multas</h1>
                <p class="lead">Gest√£o de multas por atraso na devolu√ß√£o de livros</p>
            </div>
        </div>

        <!-- Cards de Estat√≠sticas -->
        <div class="row mb-5">
            <div class="col-md-3 mb-4">
                <div class="stats-card text-center p-4">
                    <div class="card-icon text-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 class="stats-number" id="total-multas-pendentes">
                        <span class="loading-spinner"></span>
                    </h3>
                    <p class="text-muted">Multas Pendentes</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stats-card text-center p-4">
                    <div class="card-icon text-warning">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <h3 class="stats-number" id="valor-total-pendente">
                        <span class="loading-spinner"></span>
                    </h3>
                    <p class="text-muted">Valor Pendente</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stats-card text-center p-4">
                    <div class="card-icon text-success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="stats-number" id="total-multas-pagas">
                        <span class="loading-spinner"></span>
                    </h3>
                    <p class="text-muted">Multas Pagas</p>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="stats-card text-center p-4">
                    <div class="card-icon text-info">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="stats-number" id="valor-total-arrecadado">
                        <span class="loading-spinner"></span>
                    </h3>
                    <p class="text-muted">Total Arrecadado</p>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Status da Multa</label>
                    <select class="form-select" id="filtroStatus" onchange="aplicarFiltros()">
                        <option value="todos">Todos os Status</option>
                        <option value="pendente">Pendente</option>
                        <option value="pago">Pago</option>
                        <option value="isento">Isento</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Per√≠odo</label>
                    <select class="form-select" id="filtroPeriodo" onchange="aplicarFiltros()">
                        <option value="todos">Todos os Per√≠odos</option>
                        <option value="hoje">Hoje</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este M√™s</option>
                        <option value="ano">Este Ano</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Buscar</label>
                    <div class="input-group">
                        <input type="text" id="buscaInput" class="form-control" placeholder="Usu√°rio, livro..." onkeyup="aplicarFiltros()">
                        <button class="btn btn-outline-secondary" type="button" onclick="aplicarFiltros()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p>Carregando multas...</p>
        </div>

        <!-- Lista de Multas -->
        <div class="module-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-list me-2"></i>Lista de Multas</h3>
                <div id="contador-resultados" class="text-muted"></div>
            </div>

            <div id="multas-container">
                <div class="text-center py-5">
                    <span class="loading-spinner me-2"></span>
                    Carregando multas...
                </div>
            </div>
        </div>

        <!-- Hist√≥rico de Pagamentos -->
        <div class="module-section">
            <h3 class="mb-4"><i class="fas fa-history me-2"></i>Hist√≥rico de Pagamentos</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Data</th>
                            <th>Usu√°rio</th>
                            <th>Livro</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="historico-body">
                        <tr>
                            <td colspan="6" class="text-center">
                                <span class="loading-spinner me-2"></span>
                                Carregando hist√≥rico...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Pagamento -->
    <div class="modal fade" id="modalRegistrarPagamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registrar Pagamento de Multa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="multaId">
                    <div class="mb-3">
                        <label class="form-label">Usu√°rio</label>
                        <input type="text" class="form-control" id="usuarioNome" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Livro</label>
                        <input type="text" class="form-control" id="livroTitulo" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor da Multa</label>
                        <input type="text" class="form-control" id="valorMulta" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Data do Pagamento</label>
                        <input type="date" class="form-control" id="dataPagamento" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M√©todo de Pagamento</label>
                        <select class="form-select" id="metodoPagamento" required>
                            <option value="">Selecione...</option>
                            <option value="dinheiro">Dinheiro</option>
                            <option value="pix">PIX</option>
                            <option value="cartao">Cart√£o</option>
                            <option value="transferencia">Transfer√™ncia</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comprovante (opcional)</label>
                        <input type="text" class="form-control" id="comprovante" placeholder="N√∫mero do comprovante...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="registrarPagamento()">
                        <span id="btnRegistrarText">Registrar Pagamento</span>
                        <span id="btnRegistrarLoading" class="d-none">
                            <span class="loading-spinner"></span> Registrando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Isentar Multa -->
    <div class="modal fade" id="modalIsentarMulta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Isentar Multa</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="multaIsentarId">
                    <div class="mb-3">
                        <label class="form-label">Usu√°rio</label>
                        <input type="text" class="form-control" id="usuarioIsentarNome" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Livro</label>
                        <input type="text" class="form-control" id="livroIsentarTitulo" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valor da Multa</label>
                        <input type="text" class="form-control" id="valorIsentarMulta" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Motivo da Isen√ß√£o *</label>
                        <textarea class="form-control" id="motivoIsencao" rows="3" placeholder="Descreva o motivo da isen√ß√£o..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-info" onclick="confirmarIsencao()">
                        <span id="btnIsentarText">Confirmar Isen√ß√£o</span>
                        <span id="btnIsentarLoading" class="d-none">
                            <span class="loading-spinner"></span> Isentando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000/api';
        let todasMultas = [];
        let multasFiltradasAtuais = [];
        let filtroStatus = 'todos';
        let filtroPeriodo = 'todos';
        let termoBusca = '';

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üí∞ Controle de Multas carregado!');
            carregarMultas();
        });

        // Carregar multas do sistema
        async function carregarMultas() {
            try {
                mostrarLoading(true);

                // Buscar multas reais do banco
                await carregarMultasReais();
                
                // Atualizar estat√≠sticas iniciais
                atualizarEstatisticas();
                
                // Aplicar filtros iniciais
                aplicarFiltros();
                
                mostrarLoading(false);

            } catch (error) {
                console.error('‚ùå Erro ao carregar multas:', error);
                mostrarToast('Erro', 'Falha ao carregar dados das multas', 'error');
                mostrarLoading(false);
            }
        }

        // Buscar multas reais do banco
 // Buscar multas reais do banco - VERS√ÉO CORRIGIDA
async function carregarMultasReais() {
    try {
        console.log('üìã Buscando multas do banco...');
        
        // Usar a rota espec√≠fica de multas
        const response = await fetch(`${API_BASE}/multas`);
        const data = await response.json();
        
        if (data.success) {
            todasMultas = data.data.map(multa => {
                return {
                    id: multa.id,
                    usuario_id: multa.usuario_id,
                    usuario_nome: multa.usuario_nome,
                    usuario_matricula: multa.usuario_matricula,
                    livro_id: multa.livro_id,
                    livro_titulo: multa.livro_titulo,
                    livro_autor: multa.livro_autor,
                    data_emprestimo: multa.data_emprestimo,
                    data_devolucao_prevista: multa.data_devolucao_prevista,
                    data_devolucao_efetiva: multa.data_devolucao_efetiva,
                    dias_atraso: multa.dias_atraso || 
                        (multa.status === 'ativo' && new Date(multa.data_devolucao_prevista) < new Date() ? 
                         Math.ceil((new Date() - new Date(multa.data_devolucao_prevista)) / (1000 * 60 * 60 * 24)) : 0),
                    valor_multa: parseFloat(multa.valor_multa_calculado || multa.multa || 0),
                    status: multa.status_multa,
                    data_pagamento: multa.data_pagamento,
                    metodo_pagamento: multa.metodo_pagamento,
                    comprovante: multa.comprovante_pagamento,
                    motivo_isencao: multa.motivo_isencao,
                    isento: multa.isento
                };
            });

            console.log(`‚úÖ ${todasMultas.length} multas carregadas do banco`);
        } else {
            throw new Error('Erro ao carregar multas');
        }
    } catch (error) {
        console.error('‚ùå Erro ao carregar multas reais:', error);
        // Usar dados de fallback em caso de erro
        usarDadosFallbackMultas();
    }
}

        // Atualizar estat√≠sticas - CORRIGIDA para usar multas filtradas
        function atualizarEstatisticas(multasParaCalcular = null) {
            // Usar as multas fornecidas ou todas as multas
            const multas = multasParaCalcular !== null ? multasParaCalcular : todasMultas;
            
            console.log('üìä Atualizando estat√≠sticas com:', multas.length, 'multas');
            
            const multasPendentes = multas.filter(m => m.status === 'pendente').length;
            const multasPagas = multas.filter(m => m.status === 'pago').length;
            
            const valorPendente = multas
                .filter(m => m.status === 'pendente')
                .reduce((sum, m) => sum + m.valor_multa, 0);
            
            const valorArrecadado = multas
                .filter(m => m.status === 'pago')
                .reduce((sum, m) => sum + m.valor_multa, 0);

            console.log('üí∞ Valores calculados:', {
                pendentes: multasPendentes,
                valorPendente: valorPendente,
                pagas: multasPagas,
                valorArrecadado: valorArrecadado
            });

            document.getElementById('total-multas-pendentes').textContent = multasPendentes;
            document.getElementById('total-multas-pagas').textContent = multasPagas;
            document.getElementById('valor-total-pendente').textContent = `R$ ${valorPendente.toFixed(2)}`;
            document.getElementById('valor-total-arrecadado').textContent = `R$ ${valorArrecadado.toFixed(2)}`;
        }

        // Aplicar filtros - CORRIGIDA para atualizar estat√≠sticas com dados filtrados
        function aplicarFiltros() {
            filtroStatus = document.getElementById('filtroStatus').value;
            filtroPeriodo = document.getElementById('filtroPeriodo').value;
            termoBusca = document.getElementById('buscaInput').value.toLowerCase().trim();

            console.log('üîç Aplicando filtros:', { filtroStatus, filtroPeriodo, termoBusca });

            let multasFiltradas = [...todasMultas];

            // Filtro por status
            if (filtroStatus !== 'todos') {
                multasFiltradas = multasFiltradas.filter(multa => multa.status === filtroStatus);
                console.log(`üìù Filtro status "${filtroStatus}": ${multasFiltradas.length} multas`);
            }

            // Filtro por per√≠odo
            if (filtroPeriodo !== 'todos') {
                const hoje = new Date();
                multasFiltradas = multasFiltradas.filter(multa => {
                    const dataMulta = new Date(multa.data_pagamento || multa.data_devolucao_efetiva || multa.data_emprestimo);
                    
                    switch (filtroPeriodo) {
                        case 'hoje':
                            return dataMulta.toDateString() === hoje.toDateString();
                        case 'semana':
                            const umaSemanaAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                            return dataMulta >= umaSemanaAtras;
                        case 'mes':
                            return dataMulta.getMonth() === hoje.getMonth() && dataMulta.getFullYear() === hoje.getFullYear();
                        case 'ano':
                            return dataMulta.getFullYear() === hoje.getFullYear();
                        default:
                            return true;
                    }
                });
                console.log(`üìÖ Filtro per√≠odo "${filtroPeriodo}": ${multasFiltradas.length} multas`);
            }

            // Filtro por busca
            if (termoBusca) {
                multasFiltradas = multasFiltradas.filter(multa =>
                    multa.usuario_nome.toLowerCase().includes(termoBusca) ||
                    multa.livro_titulo.toLowerCase().includes(termoBusca) ||
                    multa.usuario_matricula.toLowerCase().includes(termoBusca)
                );
                console.log(`üîé Filtro busca "${termoBusca}": ${multasFiltradas.length} multas`);
            }

            // Salvar multas filtradas atuais
            multasFiltradasAtuais = multasFiltradas;

            // Atualizar contador
            document.getElementById('contador-resultados').textContent = `${multasFiltradas.length} multa(s) encontrada(s)`;

            // ATUALIZAR ESTAT√çSTICAS COM OS DADOS FILTRADOS
            atualizarEstatisticas(multasFiltradas);

            // Renderizar multas
            renderizarMultas(multasFiltradas);
            renderizarHistorico(multasFiltradas.filter(m => m.status === 'pago' || m.status === 'isento'));
        }

        // Renderizar lista de multas
        function renderizarMultas(multas) {
            const container = document.getElementById('multas-container');

            if (multas.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Nenhuma multa encontrada</h4>
                        <p class="text-muted">Tente ajustar os filtros de busca</p>
                    </div>
                `;
                return;
            }

            const html = multas.map(multa => `
                <div class="card multa-card ${getClasseStatus(multa.status)} mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="card-title">${multa.usuario_nome}</h5>
                                <p class="card-text">
                                    <strong>Matr√≠cula:</strong> ${multa.usuario_matricula}<br>
                                    <strong>Livro:</strong> ${multa.livro_titulo} - ${multa.livro_autor}<br>
                                    <strong>Dias em atraso:</strong> ${multa.dias_atraso || 0}
                                </p>
                            </div>
                            <div class="col-md-3">
                                <h4 class="text-${multa.status === 'pendente' ? 'danger' : 'success'}">
                                    R$ ${multa.valor_multa.toFixed(2)}
                                </h4>
                                <span class="badge ${getBadgeStatus(multa.status)} badge-status">
                                    ${getTextoStatus(multa.status)}
                                </span>
                            </div>
                            <div class="col-md-3 text-end">
                                ${multa.status === 'pendente' ? `
                                    <button class="btn btn-success btn-sm btn-action me-1" onclick="abrirModalPagamento(${multa.id})">
                                        <i class="fas fa-check"></i> Pagar
                                    </button>
                                    <button class="btn btn-info btn-sm btn-action" onclick="abrirModalIsencao(${multa.id})">
                                        <i class="fas fa-gift"></i> Isentar
                                    </button>
                                ` : `
                                    <span class="text-muted">
                                        ${multa.data_pagamento ? `Pago em ${new Date(multa.data_pagamento).toLocaleDateString('pt-BR')}` : 'Isento'}
                                    </span>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Renderizar hist√≥rico
        function renderizarHistorico(multas) {
            const tbody = document.getElementById('historico-body');

            if (multas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            Nenhum pagamento registrado
                        </td>
                    </tr>
                `;
                return;
            }

            const html = multas.map(multa => `
                <tr>
                    <td>${new Date(multa.data_pagamento || multa.data_devolucao_efetiva).toLocaleDateString('pt-BR')}</td>
                    <td>${multa.usuario_nome} (${multa.usuario_matricula})</td>
                    <td>${multa.livro_titulo}</td>
                    <td>R$ ${multa.valor_multa.toFixed(2)}</td>
                    <td>
                        <span class="badge ${getBadgeStatus(multa.status)}">
                            ${getTextoStatus(multa.status)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-outline-primary btn-sm" onclick="verDetalhes(${multa.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');

            tbody.innerHTML = html;
        }

        // Fun√ß√µes auxiliares de status
        function getClasseStatus(status) {
            const classes = {
                'pendente': 'multa-pendente',
                'pago': 'multa-paga',
                'isento': 'multa-isenta'
            };
            return classes[status] || '';
        }

        function getBadgeStatus(status) {
            const badges = {
                'pendente': 'bg-danger',
                'pago': 'bg-success',
                'isento': 'bg-info'
            };
            return badges[status] || 'bg-secondary';
        }

        function getTextoStatus(status) {
            const textos = {
                'pendente': 'Pendente',
                'pago': 'Pago',
                'isento': 'Isento'
            };
            return textos[status] || status;
        }

        // Modal functions
        function abrirModalPagamento(multaId) {
            const multa = todasMultas.find(m => m.id === multaId);
            if (!multa) return;

            document.getElementById('multaId').value = multa.id;
            document.getElementById('usuarioNome').value = `${multa.usuario_nome} (${multa.usuario_matricula})`;
            document.getElementById('livroTitulo').value = multa.livro_titulo;
            document.getElementById('valorMulta').value = `R$ ${multa.valor_multa.toFixed(2)}`;
            document.getElementById('dataPagamento').value = new Date().toISOString().split('T')[0];
            document.getElementById('metodoPagamento').value = '';
            document.getElementById('comprovante').value = '';

            const modal = new bootstrap.Modal(document.getElementById('modalRegistrarPagamento'));
            modal.show();
        }

        function abrirModalIsencao(multaId) {
            const multa = todasMultas.find(m => m.id === multaId);
            if (!multa) return;

            document.getElementById('multaIsentarId').value = multa.id;
            document.getElementById('usuarioIsentarNome').value = `${multa.usuario_nome} (${multa.usuario_matricula})`;
            document.getElementById('livroIsentarTitulo').value = multa.livro_titulo;
            document.getElementById('valorIsentarMulta').value = `R$ ${multa.valor_multa.toFixed(2)}`;
            document.getElementById('motivoIsencao').value = '';

            const modal = new bootstrap.Modal(document.getElementById('modalIsentarMulta'));
            modal.show();
        }

        // Registrar pagamento - CORRIGIDA para usar aplicarFiltros
        async function registrarPagamento() {
            const multaId = document.getElementById('multaId').value;
            const dataPagamento = document.getElementById('dataPagamento').value;
            const metodoPagamento = document.getElementById('metodoPagamento').value;
            const comprovante = document.getElementById('comprovante').value;

            if (!dataPagamento || !metodoPagamento) {
                mostrarToast('Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios', 'warning');
                return;
            }

            try {
                mostrarBtnRegistrarLoading(true);

                // Simular registro de pagamento
                const multaIndex = todasMultas.findIndex(m => m.id == multaId);
                if (multaIndex !== -1) {
                    todasMultas[multaIndex].status = 'pago';
                    todasMultas[multaIndex].data_pagamento = dataPagamento;
                    todasMultas[multaIndex].metodo_pagamento = metodoPagamento;
                    todasMultas[multaIndex].comprovante = comprovante;
                }

                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalRegistrarPagamento')).hide();
                
                // ATUALIZAR APLICANDO FILTROS ATUAIS
                aplicarFiltros();
                
                mostrarToast('Sucesso', 'Pagamento registrado com sucesso!', 'success');

            } catch (error) {
                console.error('‚ùå Erro ao registrar pagamento:', error);
                mostrarToast('Erro', 'Falha ao registrar pagamento', 'error');
            } finally {
                mostrarBtnRegistrarLoading(false);
            }
        }

        // Confirmar isen√ß√£o - CORRIGIDA para usar aplicarFiltros
// Confirmar isen√ß√£o - VERS√ÉO CORRIGIDA COM API REAL
async function confirmarIsencao() {
    const multaId = document.getElementById('multaIsentarId').value;
    const motivoIsencao = document.getElementById('motivoIsencao').value;

    if (!motivoIsencao) {
        mostrarToast('Aten√ß√£o', 'Informe o motivo da isen√ß√£o', 'warning');
        return;
    }

    try {
        mostrarBtnIsentarLoading(true);

        // Chamar API real para isentar multa
        const response = await fetch(`${API_BASE}/emprestimos/${multaId}/isentar`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                motivo: motivoIsencao
            })
        });

        const data = await response.json();

        if (data.success) {
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('modalIsentarMulta')).hide();
            
            // Recarregar multas do servidor
            await carregarMultasReais();
            
            // Aplicar filtros para atualizar a interface
            aplicarFiltros();
            
            mostrarToast('Sucesso', 'Multa isenta com sucesso!', 'success');
        } else {
            throw new Error(data.error);
        }

    } catch (error) {
        console.error('‚ùå Erro ao isentar multa:', error);
        mostrarToast('Erro', 'Falha ao isentar multa: ' + error.message, 'error');
    } finally {
        mostrarBtnIsentarLoading(false);
    }
}

// Registrar pagamento - VERS√ÉO CORRIGIDA COM API REAL
async function registrarPagamento() {
    const multaId = document.getElementById('multaId').value;
    const dataPagamento = document.getElementById('dataPagamento').value;
    const metodoPagamento = document.getElementById('metodoPagamento').value;
    const comprovante = document.getElementById('comprovante').value;

    if (!dataPagamento || !metodoPagamento) {
        mostrarToast('Aten√ß√£o', 'Preencha todos os campos obrigat√≥rios', 'warning');
        return;
    }

    try {
        mostrarBtnRegistrarLoading(true);

        // Chamar API real para registrar pagamento
        const response = await fetch(`${API_BASE}/emprestimos/${multaId}/pagar`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                metodo_pagamento: metodoPagamento,
                comprovante: comprovante
            })
        });

        const data = await response.json();

        if (data.success) {
            // Fechar modal
            bootstrap.Modal.getInstance(document.getElementById('modalRegistrarPagamento')).hide();
            
            // Recarregar multas do servidor
            await carregarMultasReais();
            
            // Aplicar filtros para atualizar a interface
            aplicarFiltros();
            
            mostrarToast('Sucesso', 'Pagamento registrado com sucesso!', 'success');
        } else {
            throw new Error(data.error);
        }

    } catch (error) {
        console.error('‚ùå Erro ao registrar pagamento:', error);
        mostrarToast('Erro', 'Falha ao registrar pagamento: ' + error.message, 'error');
    } finally {
        mostrarBtnRegistrarLoading(false);
    }
}

        // Ver detalhes
        function verDetalhes(multaId) {
            const multa = todasMultas.find(m => m.id === multaId);
            if (!multa) return;

            let detalhes = `
                Usu√°rio: ${multa.usuario_nome} (${multa.usuario_matricula})\n
                Livro: ${multa.livro_titulo} - ${multa.livro_autor}\n
                Valor: R$ ${multa.valor_multa.toFixed(2)}\n
                Status: ${getTextoStatus(multa.status)}\n
            `;

            if (multa.data_pagamento) {
                detalhes += `Data Pagamento: ${new Date(multa.data_pagamento).toLocaleDateString('pt-BR')}\n`;
                detalhes += `M√©todo: ${multa.metodo_pagamento}\n`;
                if (multa.comprovante) {
                    detalhes += `Comprovante: ${multa.comprovante}\n`;
                }
            }

            if (multa.motivo_isencao) {
                detalhes += `Motivo Isen√ß√£o: ${multa.motivo_isencao}\n`;
            }

            alert('üìã Detalhes da Multa\n\n' + detalhes);
        }

        // Fun√ß√µes auxiliares de UI
        function mostrarLoading(mostrar) {
            document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
        }

        function mostrarBtnRegistrarLoading(mostrar) {
            document.getElementById('btnRegistrarText').classList.toggle('d-none', mostrar);
            document.getElementById('btnRegistrarLoading').classList.toggle('d-none', !mostrar);
        }

        function mostrarBtnIsentarLoading(mostrar) {
            document.getElementById('btnIsentarText').classList.toggle('d-none', mostrar);
            document.getElementById('btnIsentarLoading').classList.toggle('d-none', !mostrar);
        }

        function mostrarToast(titulo, mensagem, tipo) {
            const toast = document.getElementById('liveToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            
            const cores = {
                'success': 'text-bg-success',
                'error': 'text-bg-danger',
                'warning': 'text-bg-warning',
                'info': 'text-bg-info'
            };
            
            toast.className = `toast ${cores[tipo] || 'text-bg-primary'}`;
            toastTitle.textContent = titulo;
            toastMessage.textContent = mensagem;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    </script>
</body>
</html>